
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://homies-theta.vercel.app/logo.png" type="image/x-icon">
    <link rel="shortcut icon" href="https://homies-theta.vercel.app/logo.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>360Hub: </title>
    <link rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.min.css"> <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
    <style>
        body { background-color: #111; color: white; }
        .video-player { max-width: 900px; margin: 20px auto; padding: 10px; }
        .vjs-big-play-centered .vjs-big-play-button { top: 50%; left: 50%; margin-top: -0.75em; margin-left: -1.5em; }
        .container-btns { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .card { border-radius: 10px; overflow: hidden; }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-primary mb-3 p-1" data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="https://homies-theta.vercel.app/logo.png" alt="Logo" height="40">
            </a>
            <div class="d-flex">
                <form id="signoutForm" action="/logout" method="post" class="d-flex" role="logout">
                    <button type="submit" class="btn btn-secondary btn-sm">
                        <i class="bi bi-box-arrow-left"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="video-player">
        <div id="status-msg" class="alert alert-info text-center" style="display:none;">
            Preparing HLS Stream... Please wait.
        </div>

        <video id="player" class="video-js vjs-big-play-centered vjs-fluid" controls preload="auto" playsinline crossorigin="anonymous" poster="">
        </video> 
        
        <div class="card bg-light text-dark mt-3">
            <div class="card-body">
                <h5 class="card-title">üé¨ </h5>
                <p class="card-text mb-1">üåê <strong>Language:</strong> Multi-Audio</p>
                <p class="card-text mb-0">‚è±Ô∏è <strong>Duration:</strong> </p>
            </div>
        </div>

        <div class="container-btns">
            <div onclick="mx_player()" class="btn btn-outline-primary">MX Player</div>
            <div onclick="vlc_player()" class="btn btn-outline-primary">VLC Mobile</div>
            <div onclick="copyUrl()" class="btn btn-outline-info">Copy Link</div> 
            <div onclick="download()" class="btn btn-success">Download</div>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <script>
        // 1. URL LOGIC
        const videolink = window.location.href;
        const url = new URL(videolink);
        const domainUrl = url.origin;
        const videoIdWithParams = videolink.split('/').pop();
        const videoId = videoIdWithParams.split('?')[0];
        const idParam = new URLSearchParams(window.location.search).get('id');
        const hashParam = new URLSearchParams(window.location.search).get('hash');
        const encodedName = encodeURIComponent('');

        const downloadlink = `${domainUrl}/${videoId}/${encodedName}?id=${idParam}&hash=${hashParam}`;
        const rawDomain = domainUrl.replace(/^https?:\/\//, "");
        const downloadlink1 = `${rawDomain}/${videoId}/${encodedName}?id=${idParam}&hash=${hashParam}`;

        // 2. INITIALIZE PLAYER
        const player = videojs('player', {
            playbackRates: [0.5, 1, 1.5, 2],
            responsive: true,
            fluid: true
        });

        // 3. START HLS LOGIC
        const backendUrl = 'https://hls-converter-sy1z.onrender.com/convert';
        const statusMsg = document.getElementById('status-msg');

        async function startHLSStream() {
            statusMsg.style.display = 'block';
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: downloadlink })
                });
                const data = await response.json();

                if (data.hls_link) {
                    loadWithRetry(data.hls_link);
                } else {
                    throw new Error("No link received");
                }
            } catch (error) {
                console.error("HLS Failed:", error);
                statusMsg.className = "alert alert-warning text-center";
                statusMsg.innerHTML = "HLS Error. Playing Direct MP4...";
                player.src({ src: downloadlink, type: 'video/mp4' });
            }
        }

        async function loadWithRetry(url, retries = 30) {
            try {
                const check = await fetch(url, { method: 'HEAD' });
                if (check.ok) {
                    statusMsg.style.display = 'none';
                    player.src({ src: url, type: 'application/x-mpegURL' });
                    player.play();
                } else if (retries > 0) {
                    setTimeout(() => loadWithRetry(url, retries - 1), 2000);
                }
            } catch (e) {
                if (retries > 0) setTimeout(() => loadWithRetry(url, retries - 1), 2000);
            }
        }

        // Run on load
        window.onload = startHLSStream;

        // External Player Functions
        function mx_player() { window.location.href = `intent:${downloadlink1}#Intent;package=com.mxtech.videoplayer.ad;end`; }
        function vlc_player() { window.location.href = `vlc://${downloadlink1}`; }
        function download() { window.location.href = downloadlink; }
        function copyUrl() {
            navigator.clipboard.writeText(downloadlink).then(() => alert('URL copied!'));
        }
    </script>
</body>
</html>
